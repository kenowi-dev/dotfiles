#!/usr/bin/env bash

PARENT="$( cd "$( dirname "${BASH_SOURCE[0]}" )" >/dev/null 2>&1 && pwd )"
DIR="$( cd "$( dirname "$PARENT" )" >/dev/null 2>&1 && pwd )"

#Colors
RED=`tput setaf 1`
GREEN=`tput setaf 2`
YELLOW=`tput setaf 3`
BLUE=`tput setaf 4`
MAGENTA=`tput setaf 5`
CYAN=`tput setaf 6`
RESET=`tput sgr0`

error() { printf "$(tput setaf 1)$1$(tput sgr0)\n"; }
success () { printf "$(tput setaf 2)$1$(tput sgr0)\n"; }
warn () { printf "$(tput setaf 3)$1$(tput sgr0)\n"; }
note() { printf "$(tput setaf 4)$1$(tput sgr0)\n"; }
info() { printf "$(tput setaf 5)$1$(tput sgr0)\n"; }

usage() {
  echo ""
  echo "Usage: "
  printf "\r${RESET}dotfiles <${YELLOW}command${RESET}> <${BLUE}app${RESET}[=${GREEN}argument${RESET}]>...\n"; 
  printf "\r${RESET}dotfiles ${YELLOW}help${RESET}\n"; 
  printf "\r${RESET}dotfiles ${YELLOW}path${RESET}\n"; 
  printf "\r${RESET}dotfiles ${YELLOW}update${RESET}\n"; 
  printf "\r${RESET}dotfiles ${YELLOW}diff${RESET} <${BLUE}app${RESET}>...\n";  
  printf "\r${RESET}dotfiles ${YELLOW}install${RESET} <${BLUE}app${RESET}[=${GREEN}(install-only|config-only)${RESET}]>...\n"; 
  printf "\r${RESET}dotfiles ${YELLOW}remove${RESET} <${BLUE}app${RESET}[=${GREEN}config-only${RESET}]>...\n"; 
  echo ""
  echo "${YELLOW}Commands: ${RESET}"
  echo "  help            Shows this help message"
  echo "  diff            Show the difference between the installed files and the files in this repository."
  echo "  install         Installs apps and their config."
  echo "  update          Updates the repository (does NOT run install)"
  echo "  remove          Removes apps and their config."
  echo "  path            Show the path to the dotfiles directory"
  echo ""
  echo "${BLUE}Apps: ${RESET}"
  echo "  --all           Installs and configures all apps."
  echo "  --asdf          Installs and configures asdf."
  echo "  --vscode        Installs and configures vscode."
  echo "  --git           Installs and configures git."
  echo "  --system        Configures some system settings."
  echo "  --zsh           Installs and configures zsh."
  echo ""
  echo "${GREEN}Argument: ${RESET}"
  echo "  install-only    Only installs the app, without configuring it."
  echo "  config-only     Only configures the app. If the app is not installed, this will do nothing."
  echo ""
}

install() {
  for i in "$@"; do
    # Split Parameter in app and argument parts
    APP="${i%=*}"
    ARGUMENT="${i#$APP}"
    ARGUMENT="${ARGUMENT#=}"


    case "X$ARGUMENT" in 
      "Xinstall-only") ;;
      "Xconfig-only ") ;;
      *)
        error "Invalid argument: $ARGUMENT"
        echo "Use 'dotfiles help' for Usage."
        exit
        ;;
    esac

    case "$APP" in
      "--all")
        source "$DIR/apps/asdf/install.sh" "$ARGUMENT"
        source "$DIR/apps/vscode/install.sh" "$ARGUMENT"
        source "$DIR/apps/git/install.sh" "$ARGUMENT"
        source "$DIR/apps/zsh/install.sh" "$ARGUMENT"
        ;;
      "--asdf")
        source "$INSTALL_DIR/apps/asdf/install.sh" "$ARGUMENT"
        exit
        ;;
      "--vscode")
        source "$INSTALL_DIR/apps/vscode/install.sh" "$ARGUMENT"
        exit
        ;;
      "--git")
        source "$INSTALL_DIR/apps/git/install.sh" "$ARGUMENT"
        exit
        ;;
      "--system")
        source "$INSTALL_DIR/apps/system/install.sh" "$ARGUMENT"
        exit
        ;;
      "--zsh")
        source "$INSTALL_DIR/apps/zsh/install.sh" "$ARGUMENT"
        exit
        ;;
      *)
        error "Unknown app."
        echo "Use 'dotfiles help' for Usage."
        ;;
    esac
  done
}

update () {
  if [ $# -ne 0 ]; then
    error "Unknown arguments $@"
    echo "Use 'dotfiles help' for Usage."
    exit 1
  fi

  echo "Update repository..."
  cd $UPDATE_DIR && git pull origin main -q
  if [ $? -eq 0 ]; then
    success "Updated repository"; 
    echo "To install the any new changes, run 'dotfiles --install'"
  else
    error "Error updating the repository" && exit 1
  fi
}

remove() {
  for i in "$@"; do
    # Split Parameter in app and argument parts
    APP="${i%=*}"
    ARGUMENT="${i#$APP}"
    ARGUMENT="${ARGUMENT#=}"


    case "X$ARGUMENT" in 
      "Xinstall-only") 
        error "Argument: $ARGUMENT is only allowd on the 'dotfile install' command."
        echo "Use 'dotfiles help' for Usage."
        exit
        ;;
      "Xconfig-only ") ;;
      *)
        error "Invalid argument: $ARGUMENT"
        echo "Use 'dotfiles help' for Usage."
        exit
        ;;
    esac

    case "$APP" in
      "--all")
        source "$DIR/apps/asdf/remove.sh" "$ARGUMENT"
        source "$DIR/apps/vscode/remove.sh" "$ARGUMENT"
        source "$DIR/apps/git/remove.sh" "$ARGUMENT"
        source "$DIR/apps/zsh/remove.sh" "$ARGUMENT"
        ;;
      "--asdf")
        source "$INSTALL_DIR/apps/asdf/remove.sh" "$ARGUMENT"
        exit
        ;;
      "--vscode")
        source "$INSTALL_DIR/apps/vscode/remove.sh" "$ARGUMENT"
        exit
        ;;
      "--git")
        source "$INSTALL_DIR/apps/git/remove.sh" "$ARGUMENT"
        exit
        ;;
      "--system")
        source "$INSTALL_DIR/apps/system/remove.sh" "$ARGUMENT"
        exit
        ;;
      "--zsh")
        source "$INSTALL_DIR/apps/zsh/remove.sh" "$ARGUMENT"
        exit
        ;;
      *)
        error "Unknown app."
        echo "Use 'dotfiles help' for Usage."
        ;;
    esac
  done
}

dotfile_diff() {
  if [ $# -eq 0 ]; then
    error "Missing app"
    echo "Use 'dotfiles help' for Usage."
    exit 1
  fi

  while [[ $# -gt 0 ]]; do
    case "$1" in
      "--all")
        source "$DIR/apps/asdf/diff.sh" 
        source "$DIR/apps/vscode/diff.sh"
        source "$DIR/apps/git/diff.sh" 
        source "$DIR/apps/zsh/diff.sh" 
        ;;
      "--asdf")
        source "$INSTALL_DIR/apps/asdf/diff.sh"
        exit
        ;;
      "--vscode")
        source "$INSTALL_DIR/apps/vscode/diff.sh"
        exit
        ;;
      "--git")
        source "$INSTALL_DIR/apps/git/diff.sh"
        exit
        ;;
      "--system")
        source "$INSTALL_DIR/apps/system/diff.sh"
        exit
        ;;
      "--zsh")
        source "$INSTALL_DIR/apps/zsh/diff.sh"
        exit
        ;;
      *)
        error "Unknown app."
        echo "Use 'dotfiles help' for Usage."
        ;;
    esac
    shift
  done
}

path() {
  if [ $# -ne 0 ]; then
    error "Unknown arguments $@"
    echo "Use 'dotfiles help' for Usage."
    exit 1
  fi

  printf "Path to dotfile repository: "
  note "$DIR"; 
}

######## ENTRY POINT ########

# Exit if no command is given
if [ $# -eq 0 ]; then 
  error "No command given."
  echo "Use 'dotfiles help' for Usage."
  exit 1
fi


COMMAND=$1
shift
# Check the command and run the appropriate function
case "X$COMMAND" in 
  "Xinstall") 
    install "$@"
    exit
    ;;
  "Xremove") 
    remove "$@"
    ;;
  "Xhelp")
    usage
    exit
    ;;  
  "Xupdate") 
    update "$@"
    exit
    ;;
  "Xdiff") 
    dotfile_diff "$@"
    exit
    ;;
  "Xpath") 
    path "$@"
    exit
    ;;
  *)
    error "Invalid command: $COMMAND"
    echo ""
    usage
    exit
    ;;
esac
